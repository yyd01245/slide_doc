
# uprtc qos

* what's qos
* rtp/rtcp
* nack
* fec
* jitter buffer
* gcc
* fir/pli



---

## qos 概念

网络是理想的，即无丢包，无抖动，低延时，那么接收到一帧完整数据就直接播放，效果也一定会非常好。但是实际的网络总是复杂的，尤其无线网络。如果还是这样直接播放，网络稍微变差，视频就会卡顿，出现马赛克等。qos 就是针对这些

音视频的通话质量与以下因素有关：

* 一是编码码率、帧率和分辨率等编码因素；
* 二是网络的接入类型和接入设备性能；
* 三是对丢包、抖动、乱序以及网络拥塞的自适应调整能力，即QoS（Qualityof Service，服务质量）




---


## rtp/rtcp 

rfc3550

交互式实时视频应用通常采用 RTP 协议进行音视频传输，RTP头部提供了诸如负载类型、时间戳、序列号和同步源等信息保证基本的音视频传输需求。RTP协议底层采用不可靠的 UDP 传输层协议，当网络过载或拥塞，无法实现对丢包、抖动、乱序以及网络拥塞的自适应调整。与音频相比，视频传输由于所占的带宽更大，更易受到网络环境变化的影响，Qos 提升途径.

RTP提供带有实时特性的端对端数据传输服务，传输的数据如：交互式的音频和视频。那些服务包括有效载荷类型定义，序列号，时间戳和传输监测控制

RTP控制协议(RTCP)向会议中所有成员周期性发送控制包。它使用与数据包相同的传输机制。底层协议必须提供数据包和控制包的复用

SR：发送者报告，描述作为活跃发送者成员的发送和接收统计数字；
RR：接收者报告，描述非活跃发送者成员的接收统计数字；

媒体流数据结构

```



```

---
 
 
## 抗丢包

弱网抗丢包策略:
基于NACK反馈的丢包重传，前向纠错FEC和参考帧选择RPS，这些策略通常与编解码端的容错技术（如：帧内刷新和错误隐藏）配合使用。

基于NACK反馈的丢包重传方法(RFC4585)：接收端循环检查接收缓冲，当发现丢包后使用RTCPNACK反馈报文将丢包信息反馈给发送端；发送端接收NACK反馈并解析后从发送缓存取出对应RTP包，并再次发送给接收端。该方法的缺点是增大了端到端的延迟，尤其在丢包大量发生时更为明显。

前向纠错FEC：FEC机制是在接收端根据视频帧的重要性（参考帧或非参考帧）发送冗余的视频RTP包，在接收端如果检测到丢包则利用冗余包进行恢复，否则将冗余包丢弃。该方法的优点是视频无延迟，但发送冗余包占用了额外的带宽资源。
　　
比较理想的抗丢包方案 nack + fec 模式

接收端根据帧大小和接收时延估计可用带宽，发送端根据可用带宽、丢包和RTT等反馈计算分配保护开销（protectionoverhead，包括FEC bitrate、NACK bitrate）和视频编码码率各占的比率。具体来说，FEC的保护级别（protectionlevel）取决于往返时间RTT，当RTT较小时，丢包重传的延时不会导致明显的视频卡顿，因此可以相应减少FEC包的数量；当RTT较大时，时延对视频流畅度影响明显，因此要相应增加FEC包的数量。此外，可以使用多帧FEC和结合时域分层信息的FEC，二者都可以在减小保护开销的同时，提供更低的渲染抖动、更低的端到端延迟和更高的视频质量。

---

## 抖动、乱序

抖动, 乱序主要依赖于 jitter buffer 修正, 但同时也会与其他的 qos 策略紧密相连。 如丢包则需要 nack. 丢帧则会请求 fir. 调整 jitter buffer 牺牲延时为代价的。要在延时和丢包、抖动之间做出平衡。

---

## 网络拥塞控制

码率自适应

 
把针对丢包判定的网络拥塞数据图，基于丢包的拥塞判断

 
基于丢包：

优点：简单

缺点：误判和不及时，体现在

噪音信号大，真实网络的丢包率和模拟器的差别太大了，难以准确估计，可采用一些滤波器，但是效果依然一般；
丢包率与带宽有时没啥关系，导致误判。即丢包很多时候并非由于网络带宽不够用；
历史估计未来，缺乏预判性。假定丢包是因为带宽不够用导致，等感知到丢包，说明网络已经拥塞，这将导致视频卡顿等问题；另一方面，通过感知到丢包到应用层才去策略，需要一定的时间，这段时间将进一步导致拥塞。这在对延迟要求高的场景下，效果极为差劲~

基于延时预测: WebRTC的内部实现采用Google提出的算法：Google Congestion Control，简称GCC。接收端采用的是 

---

## 关键帧请求

关键帧也叫做即时刷新帧，简称IDR帧。对视频来说，IDR帧的解码无需参考之前的帧，因此在丢包C严重时可以通过发送关键帧请求进行画面的恢复。关键帧的请求方式分为三种：RTCP FIR反馈（Full intra frame request）、RTCP PLI反馈（Picture Loss Indictor）或 SIPInfo 消息，具体使用哪种可通过协商确定。


在互联网上为实时交互式音视频应用提供QoS保证仍是一项挑战，需要音视频编码器、传输、预处理等多模块的协作配合，或利用现有网络协议和设备的支持，才能提供给客户更多的选择和服务保证。

---

## RTX